rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isValidEmail(email) {
      return email.matches('^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$');
    }
    
    function isValidMobile(mobile) {
      return mobile.matches('^[0-9]{10}$');
    }
    
    function isValidTimestamp() {
      return request.resource.data.submittedAt == request.time;
    }
    
    // Contact form submissions
    match /contactsfromwebsite/{document} {
      // Only authenticated admins can read
      allow read: if request.auth != null;
      
      // Anyone can create (write-only), with validation
      allow create: if 
        request.resource.data.keys().hasAll(['name', 'mobile', 'city', 'service', 'submittedAt', 'status']) &&
        request.resource.data.name is string &&
        request.resource.data.name.size() > 0 &&
        request.resource.data.name.size() <= 100 &&
        request.resource.data.mobile is string &&
        isValidMobile(request.resource.data.mobile) &&
        request.resource.data.city is string &&
        request.resource.data.city.size() > 0 &&
        request.resource.data.city.size() <= 100 &&
        request.resource.data.service is string &&
        request.resource.data.service.size() > 0 &&
        request.resource.data.status == 'new' &&
        isValidTimestamp();
      
      // Only admins can update
      allow update: if request.auth != null;
      
      // Only admins can delete
      allow delete: if request.auth != null;
    }
    
    // Career applications
    match /careersfromwebsite/{document} {
      // Only authenticated admins can read
      allow read: if request.auth != null;
      
      // Anyone can create (write-only), with validation
      allow create: if 
        request.resource.data.keys().hasAll(['name', 'mobile', 'email', 'qualification', 'applyingFor', 'city', 'submittedAt', 'status']) &&
        request.resource.data.name is string &&
        request.resource.data.name.size() > 0 &&
        request.resource.data.name.size() <= 100 &&
        request.resource.data.mobile is string &&
        isValidMobile(request.resource.data.mobile) &&
        request.resource.data.email is string &&
        isValidEmail(request.resource.data.email) &&
        request.resource.data.qualification is string &&
        request.resource.data.qualification.size() > 0 &&
        request.resource.data.qualification.size() <= 200 &&
        request.resource.data.applyingFor is string &&
        request.resource.data.applyingFor in ['App Developer', 'Website Developer', 'Software Developer'] &&
        request.resource.data.city is string &&
        request.resource.data.city.size() > 0 &&
        request.resource.data.city.size() <= 100 &&
        request.resource.data.status == 'new' &&
        isValidTimestamp();
      
      // Only admins can update
      allow update: if request.auth != null;
      
      // Only admins can delete
      allow delete: if request.auth != null;
    }
    
    // Free quotes and training enrollments
    match /freequotefromwebsite/{document} {
      // Only authenticated admins can read
      allow read: if request.auth != null;
      
      // Anyone can create (write-only), with validation
      allow create: if 
        // Validate common required fields
        request.resource.data.mobile is string &&
        isValidMobile(request.resource.data.mobile) &&
        request.resource.data.city is string &&
        request.resource.data.city.size() > 0 &&
        request.resource.data.city.size() <= 100 &&
        request.resource.data.status == 'new' &&
        isValidTimestamp() &&
        (
          // Free quote validation
          (
            request.resource.data.keys().hasAll(['name', 'mobile', 'city', 'submittedAt', 'status']) &&
            !request.resource.data.keys().hasAny(['type']) &&
            request.resource.data.name is string &&
            request.resource.data.name.size() > 0 &&
            request.resource.data.name.size() <= 100
          ) ||
          // Training enrollment validation
          (
            request.resource.data.keys().hasAll(['fullName', 'mobile', 'city', 'course', 'duration', 'type', 'submittedAt', 'status']) &&
            request.resource.data.fullName is string &&
            request.resource.data.fullName.size() > 0 &&
            request.resource.data.fullName.size() <= 100 &&
            request.resource.data.course is string &&
            request.resource.data.course in ['Full Stack Development', 'Front-End Development', 'Back-End Development', 'Website Development', 'Mobile App Development', 'Software Development'] &&
            request.resource.data.duration is string &&
            request.resource.data.duration in ['1', '2', '3', '4', '5', '6'] &&
            request.resource.data.type == 'training'
          )
        );
      
      // Only admins can update
      allow update: if request.auth != null;
      
      // Only admins can delete
      allow delete: if request.auth != null;
    }
    
    // Deny all other collections by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
